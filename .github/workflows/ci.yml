name: CI

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build:
    name: Build & Test (gcc / clang)
    runs-on: ubuntu-latest
    strategy:
      matrix:
        compiler: [gcc, clang]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install build tools
        run: |
          sudo apt-get update -y
          sudo apt-get install -y build-essential clang

      - name: Build (debug)
        shell: bash
        run: |
          cd project-template
          # Use clang++ for the clang matrix, g++ for gcc
          if [ "${{ matrix.compiler }}" = "clang" ]; then
            CXX=clang++ make clean all
          else
            CXX=g++ make clean all
          fi

      - name: Run tests
        shell: bash
        run: |
          cd project-template
          # `make test` should build and run bin/test_add (exit non-zero on failure)
          make test

  sanitize:
    name: Build & Run (AddressSanitizer + UBSan)
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install build tools
        run: |
          sudo apt-get update -y
          sudo apt-get install -y build-essential

      - name: Build with sanitizers
        shell: bash
        run: |
          cd project-template
          make clean || true
          # Use flags you listed earlier (AddressSanitizer + UndefinedBehavior)
          CXXFLAGS='-std=c++20 -Wall -Wextra -Wpedantic -g -O1 -fsanitize=address,undefined -fno-omit-frame-pointer' make all

      - name: Run sanitize target
        shell: bash
        # Your `sanitize` target runs ./bin/app automatically (per your Makefile notes).
        run: |
          cd project-template
          CXXFLAGS='-std=c++20 -Wall -Wextra -Wpedantic -g -O1 -fsanitize=address,undefined -fno-omit-frame-pointer' make sanitize